/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var L=Object.defineProperty;var N=Object.getOwnPropertyDescriptor;var k=Object.getOwnPropertyNames;var R=Object.prototype.hasOwnProperty;var U=(i,t)=>{for(var e in t)L(i,e,{get:t[e],enumerable:!0})},V=(i,t,e,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of k(t))!R.call(i,n)&&n!==e&&L(i,n,{get:()=>t[n],enumerable:!(s=N(t,n))||s.enumerable});return i};var H=i=>V(L({},"__esModule",{value:!0}),i);var z={};U(z,{default:()=>A});module.exports=H(z);var b=require("obsidian");var o=require("obsidian");var m={aiModel:"",ollamaURL:"http://localhost:11434",temperature:.1,isContextFreeChatsEnabled:!1};var c=class extends o.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}addOllamaURL(t){new o.Setting(t).setName("Ollama URL").setDesc("The local URL of the model you want to chat with").addText(e=>e.setPlaceholder(m.ollamaURL).setValue(this.plugin.settings.ollamaURL).onChange(async s=>{this.plugin.settings.ollamaURL=s,await this.plugin.saveSettings()}))}addModelSelector(t){new o.Setting(t).setName("Model").setDesc("The model you want to chat with").addDropdown(e=>{this.plugin.ai.getModelList().then(s=>{for(let n=0;n<s.length;n++){let I=s[n];e.addOption(I,I)}e.setValue(this.plugin.settings.aiModel)}),e.onChange(async s=>{this.plugin.settings.aiModel=s,await this.plugin.saveSettings()})})}addHyperParameterTemperature(t){new o.Setting(t).setName("Temperature").setDesc("Controls the temperature hyper parameter of the model").addSlider(e=>e.setLimits(.1,1,.05).setValue(this.plugin.settings.temperature).setDynamicTooltip().onChange(async s=>{this.plugin.settings.temperature=s,await this.plugin.saveSettings()}))}addEnableContextFreeChats(t){new o.Setting(t).setName("Enable context-free chats").setDesc("Add the option for LLM chats without the context of a note or folder").addToggle(e=>e.setValue(this.plugin.settings.isContextFreeChatsEnabled).onChange(async s=>{this.plugin.settings.isContextFreeChatsEnabled=s,await this.plugin.saveSettings()}))}display(){let{containerEl:t}=this;t.empty(),this.addOllamaURL(t),this.addModelSelector(t),this.addHyperParameterTemperature(t),this.addEnableContextFreeChats(t)}};var l="Mini-RAG",r=l.toLowerCase()+"-chat-window",h="brain",p=l+" Chats",B=`The following text may be referred to as a 'file', 'markdown file', 'text', 'document', etc. For this chat, you will use the text as context. 

 The Text: `,y={tags:"/api/tags",generate:"/api/generate"},a="miniRagPlugin";var P=require("obsidian");var g=class{constructor(t,e){this.plugin=t,e&&e.length>0&&this.sendInitialContext(e)}sendInitialContext(t){let e=B+t;this.plugin.ui.setDisabledState(!0),this.sendQuestion(e).then(()=>this.plugin.ui.setDisabledState(!1))}async getModelList(){let t=await(0,P.requestUrl)({method:"GET",url:`${this.plugin.settings.ollamaURL}${y.tags}`}).then(e=>e.json.models.map(s=>s.name));return t.sort((e,s)=>e.localeCompare(s)),t}async sendQuestion(t){let e="";return await(0,P.requestUrl)({method:"POST",url:`${this.plugin.settings.ollamaURL}${y.generate}`,body:JSON.stringify({prompt:t,context:this.context,model:this.plugin.settings.aiModel,options:{temperature:this.plugin.settings.temperature},stream:!1})}).then(s=>{e=s.json.response,this.context=s.json.context}),e}};var C=require("obsidian"),f=class{constructor(t){this.vault=t}isFolder(t){return t instanceof C.TFolder}isFile(t){return t instanceof C.TFile}isFolderPath(t){return this.vault.getFolderByPath(t)!=null}async createFile(t,e){await this.vault.create(t,e)}async createFolder(t){await this.vault.createFolder(t)}async readFileText(t){let e=this.vault.getFileByPath(t);return e?await this.vault.read(e):""}readFilenameWithoutExtension(t){return this.isFile(t)?t.name.slice(0,t.name.lastIndexOf(".")):t.name}async updateFile(t,e){let s=this.vault.getFileByPath(t);s?await this.vault.modify(s,e):await this.createFile(t,e)}};var u=i=>i.toString().padStart(2,"0"),W=i=>[i.getFullYear(),u(i.getMonth()+1),u(i.getDate())].join("-")+" "+[u(i.getHours()),u(i.getMinutes()),u(i.getSeconds())].join(":"),O=i=>`${i.charAt(0).toUpperCase()}${i.slice(1)}`;var d=require("obsidian"),E=class{constructor(t){this.plugin=t,this.contextPaths=new Map}async addFileToContext(t){if(!this.contextPaths.has(t.path)){let e=await this.plugin.fileManager.readFileText(t.path);this.contextPaths.set(t.path,e)}}getContextAsText(){let t=[];for(let e of this.contextPaths.values())t.push(e);return t.join(`

`)}async addFolderToContext(t){let e=this.recurseChildren(t);for(let s of e)await this.addFileToContext(s)}recurseChildren(t){let e=[];if(t instanceof d.TFolder)for(let s of t.children)s instanceof d.TFile?e.push(s):e.push(...this.recurseChildren(s));else t instanceof d.TFile&&e.push(t);return e}};var D=require("obsidian");var T=class{constructor(t){this.htmlElement=t.createEl("span",{cls:a+"Loader"})}show(){this.htmlElement.classList.remove("hidden")}hide(){this.htmlElement.classList.add("hidden")}};var _=require("obsidian");var M=class{constructor(t,e){this.plugin=t,this.htmlElement=e.createEl("div"),this.addConvoHeading()}addConvoHeading(t){this.htmlElement.createEl("h3",{text:"Mini-RAG Chat with "+this.plugin.getModelUserFriendlyName()}),this.htmlElement.createEl("div",{text:t?"Context: "+t:"Context-Free"})}addToConversation(t,e){let s=this.htmlElement.createEl("div",{text:t,cls:a+"ConvoBox "+(e?"response":"query")});s.onclick=async()=>{await navigator.clipboard.writeText(t),new _.Notice("Message Copied")}}clear(){this.htmlElement.empty()}};var w=class{constructor(t){this.chatWindow=t}init(){let[t,e]=this.addButtonAreas(this.chatWindow.inputWrapper);this.saveButton=this.addSaveButton(t),this.summarizeButton=this.addSummarizeButton(t),this.hideSummarizeButton(),this.sendButton=this.addSendButton(e),this.blockButtonEvents=!1}addButtonAreas(t){let e=t.createEl("div",{cls:a+"ButtonArea"}),s=e.createEl("div",{cls:a+"ButtonArea left"}),n=e.createEl("div",{cls:a+"ButtonArea right"});return[s,n]}addSaveButton(t){let e=t.createEl("button",{text:"Save"});return e.addEventListener("click",async()=>{this.blockButtonEvents||await this.chatWindow.plugin.saveChat()}),e}addSummarizeButton(t){let e=t.createEl("button",{text:"Summarize"});return e.addEventListener("click",async()=>{this.blockButtonEvents||await this.chatWindow.sendTextAsChatMessage("Summarize the file")}),e}addSendButton(t){let e=t.createEl("button",{text:"Send",cls:a+"SendButton"});return e.addEventListener("click",async()=>{this.blockButtonEvents||await this.chatWindow.sendInputAsChatMessage()}),e}disableButtons(){this.blockButtonEvents=!0,this.saveButton.disabled=!0,this.summarizeButton.disabled=!0,this.sendButton.disabled=!0}enableButtons(){this.blockButtonEvents=!1,this.saveButton.removeAttribute("disabled"),this.summarizeButton.removeAttribute("disabled"),this.sendButton.removeAttribute("disabled")}showSummarizeButton(){this.summarizeButton.style.display="inline-flex"}hideSummarizeButton(){this.summarizeButton.style.display="none"}};var x=class{constructor(t){this.chatWindow=t}init(){this.htmlElement=this.chatWindow.inputWrapper.createEl("textarea",{placeholder:"Type your question here",cls:a+"QuestionBox"}),this.htmlElement.addEventListener("keyup",async t=>{t.key==="Enter"&&(t.preventDefault(),await this.chatWindow.sendInputAsChatMessage())})}getValue(){return this.htmlElement.value}setValue(t){this.htmlElement.value=t}clear(){this.setValue("")}disable(){this.htmlElement.disabled=!0}enable(){this.htmlElement.disabled=!1}};var v=class{constructor(){this.messages=[]}addMessage(t,e){this.messages.push({role:e,content:t,timestamp:W(new Date)})}addUserMessage(t){this.addMessage(t,"user")}addAssistantMessage(t){this.addMessage(t,"assistant")}clear(){this.messages=[]}get(){return this.messages}};var S=class extends D.ItemView{constructor(t,e){super(t),this.icon=h,this.plugin=e}getViewType(){return r}getDisplayText(){return l}setDisabledState(t){t?(this.loader.show(),this.buttons.disableButtons(),this.input.disable()):(this.loader.hide(),this.buttons.enableButtons(),this.input.enable())}scrollToEnd(){this.chatContainer.scrollTop=this.chatContainer.scrollHeight}async sendTextAsChatMessage(t){this.conversationWindow.addToConversation(t,!1),this.chatMessages.addUserMessage(t),this.scrollToEnd();let e=await this.plugin.ai.sendQuestion(t);this.conversationWindow.addToConversation(e,!0),this.chatMessages.addAssistantMessage(e),this.scrollToEnd()}async sendInputAsChatMessage(){let t=this.input.getValue();this.input.clear(),await this.sendTextAsChatMessage(t)}initInputArea(){this.inputWrapper=this.chatContainer.createEl("div"),this.inputWrapper.createEl("h4",{text:"Ask a question..."}),this.input=new x(this),this.input.init(),this.buttons=new w(this),this.buttons.init()}resetChat(t){this.chatMessages.clear(),this.chatStarted=new Date,this.conversationWindow.clear(),this.conversationWindow.addConvoHeading(t),t!==void 0?this.buttons.showSummarizeButton():this.buttons.hideSummarizeButton()}async onOpen(){this.chatMessages=new v,this.chatStarted=new Date,this.chatContainer=this.containerEl.children[1],this.chatContainer.classList.add(a+"ChatContainer"),this.conversationWindow=new M(this.plugin,this.chatContainer),this.loader=new T(this.chatContainer),this.initInputArea(),this.setDisabledState(!1)}async onClose(){}};var F=class{constructor(t){this.plugin=t,this.registerChatWindow(),this.registerItemsToContextMenuInNotes(),this.registerItemsToContextMenuInFileNavigator()}addMenuItemContextFreeChat(t){this.isModelSelected()&&this.plugin.settings.isContextFreeChatsEnabled&&t.addItem(e=>{e.setTitle(this.getMenuTitleOfItem()).setIcon(h).onClick(async()=>{await this.plugin.activateViewInWorkspace(this.plugin.app.workspace),this.plugin.loadAI(),this.plugin.ui.resetChat()})})}addMenuItemContextSensitiveChat(t,e){this.isModelSelected()&&t.addItem(s=>{let n=this.plugin.fileManager.readFilenameWithoutExtension(e);s.setTitle(this.getMenuTitleOfItem(n)).setIcon(h).onClick(async()=>{await this.plugin.activateViewInWorkspace(this.plugin.app.workspace),this.plugin.loadContextualizer(),this.plugin.fileManager.isFile(e)?await this.plugin.context.addFileToContext(e):this.plugin.fileManager.isFolder(e)&&await this.plugin.context.addFolderToContext(e),this.plugin.loadAI(this.plugin.context.getContextAsText()),this.plugin.ui.resetChat(n)})})}getMenuTitleOfItem(t){return"Open "+l+" chat "+(t?'(context: "'+t+'")':"(context-free)")}isModelSelected(){return this.plugin.settings.aiModel!==""}registerChatWindow(){this.plugin.registerView(r,t=>(this.plugin.ui=new S(t,this.plugin),this.plugin.ui))}registerItemsToContextMenuInNotes(){this.plugin.registerEvent(this.plugin.app.workspace.on("editor-menu",(t,e,{file:s})=>{s&&this.addMenuItemContextSensitiveChat(t,s),this.addMenuItemContextFreeChat(t)}))}registerItemsToContextMenuInFileNavigator(){this.plugin.registerEvent(this.plugin.app.workspace.on("file-menu",(t,e)=>{this.addMenuItemContextSensitiveChat(t,e),this.addMenuItemContextFreeChat(t)}))}};var A=class extends b.Plugin{async onload(){await this.loadSettings(),this.loadFileManager(),this.loadContextualizer(),this.loadAI(),this.addSettingTab(new c(this.app,this)),this.loadMenu()}onunload(){}async activateViewInWorkspace(t){let e,s=t.getLeavesOfType(r);s.length===0?(e=t.getRightLeaf(!1),await e.setViewState({type:r,active:!0})):e=s[0],await t.revealLeaf(e)}getModelUserFriendlyName(){let t=this.settings.aiModel.slice(0,this.settings.aiModel.indexOf(":"));return O(t)}loadAI(t){this.ai=new g(this,t!=null?t:"")}loadContextualizer(){this.context=new E(this)}loadFileManager(){this.fileManager=new f(this.app.vault)}loadMenu(){this.menu=new F(this)}async loadSettings(){this.settings=Object.assign({},m,await this.loadData())}async saveChat(){this.fileManager.isFolderPath(p)||await this.fileManager.createFolder(p);let t=p+"/"+this.ui.chatStarted.getTime()+" Chat with "+this.getModelUserFriendlyName()+".md",e=["## Chat"];for(let s of this.ui.chatMessages.get())e.push("#### "+s.role+"@"+s.timestamp,"- "+s.content);await this.fileManager.updateFile(t,e.join(`
`)),new b.Notice("Chat saved in: "+t)}async saveSettings(){await this.saveData(this.settings)}};

/* nosourcemap */